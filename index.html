<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plataforma DDP - Sistema Conectado a Google Sheets</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .project-card { transition: all 0.3s ease; cursor: pointer; }
    .project-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.875rem; font-weight: 600; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;

    // =========================================================
    // CONFIG
    // =========================================================
    // ⚠️ Pega aquí tu URL de despliegue del Web App de Apps Script
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/TU_WEB_APP_URL/exec';

    const ESTADOS = {
      CREADO: { label: "CREADO", color: "bg-gray-500", code: "10" },
      EN_PROCESO: { label: "EN PROCESO", color: "bg-blue-500", code: "50" },
      RESPUESTA_COMERCIAL: { label: "RESPUESTA COMERCIAL", color: "bg-yellow-500", code: "70" },
      FINALIZADO: { label: "FINALIZADO", color: "bg-green-500", code: "80" },
      ANULADO: { label: "ANULADO", color: "bg-red-500", code: "90" }
    };

    const PROCESOS = ["ficha tecnica", "Tejido", "Hoja de costo", "Acabado", "Recepción", "Muestras", "Aprobación cliente"];

    // =========================================================
    // API CLIENT (solo POST, sin preflight, con respuesta JSON)
    // =========================================================
    class GoogleSheetsAPI {
      constructor(baseUrl) {
        this.baseUrl = baseUrl;
        this.isConfigured = !!baseUrl && baseUrl.startsWith('https://');
      }

      checkConfiguration() {
        if (!this.isConfigured) {
          throw new Error('URL de Apps Script no configurada');
        }
      }

      // Solicitudes "simples" → Content-Type text/plain para evitar preflight
      async request(action, data = {}) {
        this.checkConfiguration();
        try {
          const payload = { action, ...data };
          const resp = await fetch(this.baseUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(payload)
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          // backend responde JSON siempre; para write-only basta con ok
          const result = await resp.json().catch(() => ({ success: true }));
          if (result && result.success === false && result.error) throw new Error(result.error);
          return result || { success: true };
        } catch (error) {
          throw new Error(`Error de conexión: ${error.message}`);
        }
      }

      async requestWithResponse(action, data = {}) {
        this.checkConfiguration();
        try {
          const payload = { action, ...data };
          const resp = await fetch(this.baseUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(payload)
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const result = await resp.json();
          if (result.error) throw new Error(result.error);
          return result;
        } catch (error) {
          if (error.message.includes('Failed to fetch')) {
            throw new Error('Error de conexión. Verifica la URL del Web App y que el deployment esté activo.');
          }
          throw error;
        }
      }

      // Métodos
      getProjects() { return this.requestWithResponse('getProjects'); }
      getProject(id) { return this.requestWithResponse('getProject', { id }); }
      getStats() { return this.requestWithResponse('getStats'); }
      createProject(project) { return this.request('createProject', { project }); }
      updateProject(id, project) { return this.request('updateProject', { id, project }); }
      deleteProject(id) { return this.request('deleteProject', { id }); }
      updateProjectStatus(id, status) { return this.request('updateStatus', { id, status }); }
      addComment(id, comment) { return this.request('addComment', { id, comment }); }
    }

    const api = new GoogleSheetsAPI(GOOGLE_SCRIPT_URL);

    // =========================================================
    // UI
    // =========================================================
    function Notification({ message, type, onClose }) {
      useEffect(() => {
        const t = setTimeout(onClose, 3000);
        return () => clearTimeout(t);
      }, [onClose]);
      const bg = type === 'success' ? 'bg-green-600' : type === 'warn' ? 'bg-yellow-600' : 'bg-red-600';
      const icon = type === 'success' ? 'fa-check-circle' : type === 'warn' ? 'fa-circle-exclamation' : 'fa-triangle-exclamation';
      return (
        <div className={`fixed top-6 right-4 ${bg} text-white px-4 py-3 rounded shadow z-50 flex items-center gap-2`}>
          <i className={`fas ${icon}`}></i>
          <span className="text-sm">{message}</span>
        </div>
      );
    }

    function App() {
      const [projects, setProjects] = useState([]);
      const [view, setView] = useState('dashboard');
      const [loading, setLoading] = useState(true);
      const [syncing, setSyncing] = useState(false);
      const [error, setError] = useState(null);
      const [notification, setNotification] = useState(null);
      const [lastSync, setLastSync] = useState(null);
      const [showModal, setShowModal] = useState(false);
      const [selectedProject, setSelectedProject] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [filterCliente, setFilterCliente] = useState('');
      const [filterEstado, setFilterEstado] = useState('');
      const [stats, setStats] = useState(null);
      const [configError, setConfigError] = useState(!api.isConfigured);

      const showNotification = (msg, type='error') => setNotification({ message: msg, type });

      const loadProjects = useCallback(async () => {
        if (!api.isConfigured) {
          setConfigError(true);
          setLoading(false);
          return;
        }
        try {
          setSyncing(true);
          setError(null);
          const response = await api.getProjects();
          setProjects(response.projects || []);
          setLastSync(new Date());
          try {
            const statsResponse = await api.getStats();
            setStats(statsResponse);
          } catch (e) {
            console.warn('No se pudieron cargar estadísticas:', e.message);
          }
          if (!loading) showNotification('Datos sincronizados', 'success');
        } catch (e) {
          setError(e.message);
          if (!projects.length) {
            // fallback demo
            showNotification('No se pudo conectar. Cargando datos de demostración…', 'warn');
            setProjects([
              {
                id: 2,
                codigo: "50",
                nombre: "PROYECTO DEMO 1",
                cliente: "CLIENTE DEMO",
                uso: "Camisa",
                estilo: "Hilo color",
                objetivo: "Nuevo producto",
                ligamento: "Oxford",
                hiloUrdimbre: "40/1 Cotton",
                hiloTrama: "20/2 Alg",
                pesoTeorico: ">140 gr/m2",
                ancho: "150",
                composicion: "100% CO",
                estado: "EN PROCESO",
                proceso: "Tejido",
                observaciones: "Proyecto de demostración",
                progreso: 55
              }
            ]);
          }
        } finally {
          setLoading(false);
          setSyncing(false);
        }
      }, [loading, projects.length]);

      useEffect(() => {
        loadProjects();
        const it = setInterval(loadProjects, 60000);
        return () => clearInterval(it);
      }, [loadProjects]);

      const saveProject = async (projectData) => {
        if (!api.isConfigured) return showNotification('Configura primero la URL del Web App.');
        try {
          setSyncing(true);
          if (selectedProject) {
            await api.updateProject(selectedProject.id, projectData);
            showNotification('Proyecto actualizado', 'success');
          } else {
            await api.createProject(projectData);
            showNotification('Proyecto creado', 'success');
          }
          await loadProjects();
          setShowModal(false);
          setSelectedProject(null);
        } catch (e) {
          showNotification(`Error: ${e.message}`);
        } finally {
          setSyncing(false);
        }
      };

      const deleteProject = async (id) => {
        if (!confirm('¿Eliminar este proyecto?')) return;
        try {
          setSyncing(true);
          await api.deleteProject(id);
          showNotification('Proyecto eliminado', 'success');
          await loadProjects();
        } catch (e) {
          showNotification(`Error: ${e.message}`);
        } finally {
          setSyncing(false);
        }
      };

      const clientes = useMemo(() => {
        return [...new Set(projects.map(p => p.cliente).filter(Boolean))].sort();
      }, [projects]);

      const filteredProjects = useMemo(() => {
        return projects.filter(p => {
          const s = searchTerm.trim().toLowerCase();
          const okSearch = !s ||
            (p.nombre && p.nombre.toLowerCase().includes(s)) ||
            (p.cliente && p.cliente.toLowerCase().includes(s));
          const okCliente = !filterCliente || p.cliente === filterCliente;
          const okEstado = !filterEstado || p.estado === filterEstado;
          return okSearch && okCliente && okEstado;
        });
      }, [projects, searchTerm, filterCliente, filterEstado]);

      // ====== COMPONENTES ======
      const ConfigurationPanel = () => (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full p-8">
            <div className="text-center mb-6">
              <i className="fab fa-google text-6xl text-blue-500 mb-4"></i>
              <h2 className="text-2xl font-bold text-gray-800">⚠️ Configuración requerida</h2>
              <p className="text-red-600 mt-2">Falta la URL del Web App de Apps Script</p>
            </div>
            <ol className="list-decimal pl-6 text-sm text-gray-700 space-y-2">
              <li>En Apps Script: <b>Deploy &gt; New deployment &gt; Web app</b></li>
              <li><b>Execute as:</b> Me (tu cuenta) &nbsp;|&nbsp; <b>Who has access:</b> Anyone / Anyone with the link</li>
              <li>Copia la <b>Web App URL</b> y pégala en <code>GOOGLE_SCRIPT_URL</code> (línea superior de este archivo)</li>
            </ol>
          </div>
        </div>
      );

      const ProjectModal = () => {
        const [formData, setFormData] = useState(selectedProject || {
          codigo: "50",
          nombre: "",
          cliente: "",
          uso: "Camisa",
          estilo: "Hilo color",
          objetivo: "Nuevo producto",
          ligamento: "",
          hiloUrdimbre: "",
          hiloTrama: "",
          pesoTeorico: "",
          ancho: "150",
          composicion: "",
          estado: "EN PROCESO",
          proceso: "ficha tecnica",
          observaciones: "",
          fechaMuestra: "",
          progreso: 0
        });

        const change = (k, v) => setFormData(prev => ({ ...prev, [k]: v }));

        return (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
               onClick={e => { if (e.target === e.currentTarget) { setShowModal(false); setSelectedProject(null);} }}>
            <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
              <div className="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center z-10">
                <h2 className="text-xl font-bold text-gray-800">
                  {selectedProject ? '✏️ Editar Proyecto' : '➕ Nuevo Proyecto'}
                </h2>
                <button onClick={() => { setShowModal(false); setSelectedProject(null); }}
                        className="text-gray-500 hover:text-gray-700 text-2xl">
                  <i className="fas fa-times"></i>
                </button>
              </div>

              <form onSubmit={(e) => { e.preventDefault(); saveProject(formData); }} className="p-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="col-span-2">
                    <h3 className="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">📋 Información Básica</h3>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Nombre del Proyecto *</label>
                    <input className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                           value={formData.nombre} onChange={e => change('nombre', e.target.value)} required
                           placeholder="Ej: BASE SHORT ROSADO"/>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Cliente *</label>
                    <input className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                           value={formData.cliente} onChange={e => change('cliente', e.target.value)} required
                           list="clientes-list" placeholder="Nombre del cliente"/>
                    <datalist id="clientes-list">
                      {clientes.map(c => <option key={c} value={c} />)}
                    </datalist>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Tipo/Uso</label>
                    <select className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                            value={formData.uso} onChange={e => change('uso', e.target.value)}>
                      <option value="Camisa">Camisa</option>
                      <option value="Pantalón">Pantalón</option>
                      <option value="Tñ.Pieza">Tñ.Pieza</option>
                      <option value="PPT">PPT</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Estilo</label>
                    <select className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                            value={formData.estilo} onChange={e => change('estilo', e.target.value)}>
                      <option value="Hilo color">Hilo color</option>
                      <option value="Listados">Listados</option>
                      <option value="Tñ.Pieza">Tñ.Pieza</option>
                      <option value="PPT">PPT</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Objetivo</label>
                    <select className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                            value={formData.objetivo} onChange={e => change('objetivo', e.target.value)}>
                      <option value="Nuevo producto">Nuevo producto</option>
                      <option value="Nuevos colores">Nuevos colores</option>
                      <option value="consumir hilos obsoletos">Consumir hilos obsoletos</option>
                      <option value="Imitar tela importada">Imitar tela importada</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                    <select className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                            value={formData.estado} onChange={e => change('estado', e.target.value)}>
                      {Object.values(ESTADOS).map(s => <option key={s.code} value={s.label}>{s.label}</option>)}
                    </select>
                  </div>

                  <div className="col-span-2 mt-2">
                    <h3 className="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">🔧 Información Técnica</h3>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Ligamento</label>
                    <input className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                           value={formData.ligamento} onChange={e => change('ligamento', e.target.value)}
                           placeholder="Ej: Oxford, Dobby..."/>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Hilo Urdimbre</label>
                    <input className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                           value={formData.hiloUrdimbre} onChange={e => change('hiloUrdimbre', e.target.value)}
                           placeholder="Ej: 40/1 Cotton"/>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Hilo Trama</label>
                    <input className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                           value={formData.hiloTrama} onChange={e => change('hiloTrama', e.target.value)}
                           placeholder="Ej: 20/2 Alg"/>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Peso Teórico</label>
                    <input className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                           value={formData.pesoTeorico} onChange={e => change('pesoTeorico', e.target.value)}
                           placeholder="Ej: >140 gr/m2"/>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Ancho (cm)</label>
                    <input className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                           value={formData.ancho} onChange={e => change('ancho', e.target.value)} />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Composición</label>
                    <input className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                           value={formData.composicion} onChange={e => change('composicion', e.target.value)}
                           placeholder="Ej: 100% CO"/>
                  </div>

                  <div className="col-span-2 mt-2">
                    <h3 className="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">📊 Estado Actual</h3>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Proceso actual</label>
                    <select className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                            value={formData.proceso} onChange={e => change('proceso', e.target.value)}>
                      {PROCESOS.map(p => <option key={p} value={p}>{p}</option>)}
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Fecha de muestra</label>
                    <input type="date" className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                           value={formData.fechaMuestra || ''} onChange={e => change('fechaMuestra', e.target.value)} />
                  </div>

                  <div className="col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
                    <textarea rows="3" className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                              value={formData.observaciones} onChange={e => change('observaciones', e.target.value)}
                              placeholder="Notas adicionales..."></textarea>
                  </div>
                </div>

                <div className="mt-6 flex justify-end gap-3 border-t pt-4">
                  <button type="button" onClick={() => { setShowModal(false); setSelectedProject(null); }}
                          className="px-6 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                    Cancelar
                  </button>
                  <button type="submit" disabled={syncing || !formData.nombre || !formData.cliente}
                          className="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2">
                    {syncing ? (<><i className="fas fa-spinner loading-spinner"></i>Guardando…</>) : (<><i className="fas fa-save"></i>{selectedProject ? 'Actualizar' : 'Guardar'}</>)}
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      };

      const DashboardView = () => {
        const localStats = useMemo(() => {
          const total = filteredProjects.length;
          const byStatus = {};
          const byClient = {};
          let totalProg = 0;
          filteredProjects.forEach(p => {
            byStatus[p.estado] = (byStatus[p.estado] || 0) + 1;
            byClient[p.cliente] = (byClient[p.cliente] || 0) + 1;
            totalProg += p.progreso || 0;
          });
          return { total, byStatus, byClient, avgProgress: total ? Math.round(totalProg / total) : 0 };
        }, [filteredProjects]);

        const displayStats = stats || localStats;

        return (
          <div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              <div className="bg-white rounded-lg shadow p-6">
                <div className="flex items-center justify-between mb-2">
                  <h3 className="text-sm font-medium text-gray-500">Total Proyectos</h3>
                  <i className="fas fa-folder text-2xl text-blue-500"></i>
                </div>
                <p className="text-3xl font-bold text-gray-800">{displayStats.total}</p>
                <p className="text-xs text-gray-600 mt-2">Activos en el sistema</p>
              </div>

              <div className="bg-white rounded-lg shadow p-6">
                <div className="flex items-center justify-between mb-2">
                  <h3 className="text-sm font-medium text-gray-500">En Proceso</h3>
                  <i className="fas fa-spinner text-2xl text-yellow-500"></i>
                </div>
                <p className="text-3xl font-bold text-gray-800">{displayStats.byStatus?.['EN PROCESO'] || 0}</p>
                <p className="text-xs text-gray-600 mt-2">Proyectos activos</p>
              </div>

              <div className="bg-white rounded-lg shadow p-6">
                <div className="flex items-center justify-between mb-2">
                  <h3 className="text-sm font-medium text-gray-500">Progreso Promedio</h3>
                  <i className="fas fa-chart-line text-2xl text-green-500"></i>
                </div>
                <p className="text-3xl font-bold text-gray-800">{displayStats.avgProgress}%</p>
                <p className="text-xs text-gray-600 mt-2">De todos los proyectos</p>
              </div>

              <div className="bg-white rounded-lg shadow p-6">
                <div className="flex items-center justify-between mb-2">
                  <h3 className="text-sm font-medium text-gray-500">Clientes</h3>
                  <i className="fas fa-users text-2xl text-purple-500"></i>
                </div>
                <p className="text-3xl font-bold text-gray-800">{Object.keys(displayStats.byClient || {}).length}</p>
                <p className="text-xs text-gray-600 mt-2">Clientes activos</p>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-lg font-semibold text-gray-800 mb-4">Proyectos Recientes</h3>
              <div className="space-y-3">
                {filteredProjects.slice(0, 5).map(p => {
                  const s = Object.values(ESTADOS).find(x => x.label === p.estado);
                  return (
                    <div key={p.id} className="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer"
                         onClick={() => { setSelectedProject(p); setShowModal(true); }}>
                      <div className="flex items-center gap-3">
                        <div className={`w-2 h-2 rounded-full ${s?.color || 'bg-gray-500'}`}></div>
                        <div>
                          <p className="font-medium text-gray-800">{p.nombre}</p>
                          <p className="text-sm text-gray-600">{p.cliente}</p>
                        </div>
                      </div>
                      <div className="flex items-center gap-4">
                        <div className="text-right">
                          <p className="text-sm text-gray-600">{p.proceso}</p>
                          <div className="flex items-center mt-1">
                            <div className="w-20 bg-gray-200 rounded-full h-2 mr-2">
                              <div className="bg-blue-500 h-2 rounded-full" style={{ width: `${p.progreso || 0}%` }}></div>
                            </div>
                            <span className="text-xs text-gray-600">{p.progreso || 0}%</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
                {!filteredProjects.length && (
                  <div className="text-center py-8 text-gray-500">
                    <i className="fas fa-inbox text-4xl mb-2"></i>
                    <p>No hay proyectos para mostrar</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      };

      const KanbanView = () => {
        const columns = Object.values(ESTADOS).map(s => ({
          id: s.code, title: s.label, color: s.color,
          projects: filteredProjects.filter(p => p.estado === s.label)
        }));

        const onDragStart = (e, p) => e.dataTransfer.setData('projectId', p.id);
        const onDragOver = (e) => e.preventDefault();
        const onDrop = async (e, newStatus) => {
          e.preventDefault();
          const projectId = e.dataTransfer.getData('projectId');
          try {
            setSyncing(true);
            await api.updateProjectStatus(projectId, newStatus);
            showNotification('Estado actualizado', 'success');
            await loadProjects();
          } catch (err) {
            showNotification(`Error: ${err.message}`);
          } finally {
            setSyncing(false);
          }
        };

        return (
          <div className="flex gap-4 overflow-x-auto pb-4">
            {columns.map(col => (
              <div key={col.id} className="flex-shrink-0 w-80">
                <div className={`${col.color} text-white px-4 py-2 rounded-t-lg flex justify-between items-center`}>
                  <span className="font-semibold">{col.title}</span>
                  <span className="bg-white text-gray-800 px-2 py-1 rounded-full text-sm">{col.projects.length}</span>
                </div>
                <div className="bg-gray-50 min-h-[500px] p-3 rounded-b-lg" onDragOver={onDragOver}
                     onDrop={(e) => onDrop(e, col.title)}>
                  {col.projects.map(p => (
                    <div key={p.id} draggable onDragStart={(e) => onDragStart(e, p)}
                         className="project-card bg-white p-3 mb-3 rounded shadow-sm hover:shadow-md"
                         onClick={() => { setSelectedProject(p); setShowModal(true); }}>
                      <h4 className="font-semibold text-gray-800 text-sm mb-2">{p.nombre}</h4>
                      <p className="text-xs text-gray-600 mb-1"><i className="fas fa-user mr-1"></i>{p.cliente}</p>
                      <p className="text-xs text-gray-600 mb-2"><i className="fas fa-cog mr-1"></i>{p.proceso}</p>
                      <div className="w-full bg-gray-200 rounded-full h-2">
                        <div className="bg-blue-500 h-2 rounded-full" style={{ width: `${p.progreso || 0}%` }}></div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        );
      };

      const TableView = () => (
        <div className="bg-white rounded-lg shadow overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50 border-b">
                <tr>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proyecto</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proceso</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Progreso</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {filteredProjects.map(p => {
                  const s = Object.values(ESTADOS).find(x => x.label === p.estado);
                  return (
                    <tr key={p.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3 text-sm text-gray-900">{p.id}</td>
                      <td className="px-4 py-3">
                        <div className="text-sm font-medium text-gray-900">{p.nombre}</div>
                        <div className="text-xs text-gray-500">{p.ligamento} - {p.composicion}</div>
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-900">{p.cliente}</td>
                      <td className="px-4 py-3 text-sm text-gray-900">{p.uso}</td>
                      <td className="px-4 py-3">
                        <span className={`status-badge text-white ${s?.color || 'bg-gray-500'}`}>{p.estado}</span>
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-900">{p.proceso}</td>
                      <td className="px-4 py-3">
                        <div className="flex items-center">
                          <div className="w-24 bg-gray-200 rounded-full h-2 mr-2">
                            <div className="bg-blue-500 h-2 rounded-full" style={{ width: `${p.progreso || 0}%` }}></div>
                          </div>
                          <span className="text-sm text-gray-600">{p.progreso || 0}%</span>
                        </div>
                      </td>
                      <td className="px-4 py-3 text-sm">
                        <button className="text-blue-600 hover:text-blue-800 mr-3"
                                onClick={() => { setSelectedProject(p); setShowModal(true); }}>
                          <i className="fas fa-edit"></i>
                        </button>
                        <button className="text-red-600 hover:text-red-800" onClick={() => deleteProject(p.id)}>
                          <i className="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                  );
                })}
                {!filteredProjects.length && (
                  <tr>
                    <td colSpan="8" className="px-4 py-8 text-center text-gray-500">
                      <i className="fas fa-inbox text-4xl mb-2"></i>
                      <p>No hay proyectos para mostrar</p>
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      );

      // ====== RENDER ======
      if (configError) return <ConfigurationPanel />;

      return (
        <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
          {notification && (
            <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />
          )}

          <header className="bg-white shadow-sm border-b">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex justify-between items-center py-4">
                <div className="flex items-center">
                  <i className="fas fa-industry text-2xl text-blue-600 mr-3"></i>
                  <div>
                    <h1 className="text-2xl font-bold text-gray-800">Plataforma DDP</h1>
                    <p className="text-sm text-gray-600">
                      Conectado a Google Sheets
                      {lastSync && <span className="ml-2 text-xs">• Sincronizado: {lastSync.toLocaleTimeString()}</span>}
                    </p>
                  </div>
                </div>
                <div className="flex items-center space-x-3">
                  {syncing && (
                    <div className="flex items-center text-blue-600">
                      <i className="fas fa-sync loading-spinner mr-2"></i>
                      <span className="text-sm">Sincronizando...</span>
                    </div>
                  )}
                  <button onClick={loadProjects} disabled={syncing}
                          className="bg-gray-200 text-gray-700 px-3 py-2 rounded hover:bg-gray-300 disabled:opacity-50">
                    <i className="fas fa-sync-alt"></i>
                  </button>
                  <button onClick={() => { setSelectedProject(null); setShowModal(true); }}
                          className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center">
                    <i className="fas fa-plus mr-2"></i>Nuevo Proyecto
                  </button>
                </div>
              </div>
            </div>
          </header>

          <div className="bg-white border-b">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex space-x-8">
                {[
                  { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-chart-pie' },
                  { id: 'kanban', label: 'Kanban', icon: 'fas fa-columns' },
                  { id: 'table', label: 'Tabla', icon: 'fas fa-table' }
                ].map(tab => (
                  <button key={tab.id} onClick={() => setView(tab.id)}
                          className={`py-3 px-1 border-b-2 font-medium text-sm transition ${
                            view === tab.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}>
                    <i className={`${tab.icon} mr-2`}></i>{tab.label}
                  </button>
                ))}
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div className="bg-white rounded-lg shadow p-4">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Buscar</label>
                  <div className="relative">
                    <input className="w-full pl-10 pr-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                           value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                           placeholder="Proyecto o cliente..."/>
                    <i className="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                  <select className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                          value={filterCliente} onChange={e => setFilterCliente(e.target.value)}>
                    <option value="">Todos</option>
                    {clientes.map(c => <option key={c} value={c}>{c}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                  <select className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                          value={filterEstado} onChange={e => setFilterEstado(e.target.value)}>
                    <option value="">Todos</option>
                    {Object.values(ESTADOS).map(s => <option key={s.code} value={s.label}>{s.label}</option>)}
                  </select>
                </div>
              </div>
            </div>
          </div>

          {error && (
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-4">
              <div className="bg-red-50 border-l-4 border-red-400 p-4">
                <p className="text-sm text-red-700"><i className="fas fa-exclamation-triangle mr-2"></i>{error}</p>
              </div>
            </div>
          )}

          <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-8">
            {loading ? (
              <div className="flex justify-center items-center h-64">
                <div className="text-center">
                  <i className="fas fa-spinner loading-spinner text-4xl text-blue-600 mb-4"></i>
                  <p className="text-gray-600">Cargando proyectos...</p>
                </div>
              </div>
            ) : (
              <>
                {view === 'dashboard' && <DashboardView />}
                {view === 'kanban' && <KanbanView />}
                {view === 'table' && <TableView />}
              </>
            )}
          </main>

          {showModal && <ProjectModal />}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>

